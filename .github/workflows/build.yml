name: Build Optimized PawnRandomix

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  build-linux:
    name: Build Linux (.so)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-multilib g++-multilib
          
      - name: Build with optimizations
        run: |
          # Flags optimasi untuk mengalahkan MerRandom
          OPT_FLAGS="-m32 -O3 -march=native -ffast-math -funroll-loops -flto -fomit-frame-pointer"
          
          # Cari semua file .cpp di src
          CPP_FILES=$(find src -name "*.cpp")
          
          # Build library
          g++ $OPT_FLAGS -shared -fPIC \
            -I./include \
            -o pawnrandomix.so \
            $CPP_FILES
            
          # Strip untuk size kecil
          strip --strip-all pawnrandomix.so
          
          # Cek size
          ls -lh pawnrandomix.so
          
      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: pawnrandomix-linux
          path: pawnrandomix.so

  build-windows:
    name: Build Windows (.dll)
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Build with optimizations
        shell: cmd
        run: |
          echo Building Windows DLL with optimizations...
          
          rem Setup flags optimasi
          set OPT_FLAGS=/O2 /Oi /Ot /Ob2 /arch:AVX2 /fp:fast /GL /DNDEBUG
          set LINK_FLAGS=/LTCG /OPT:REF /OPT:ICF
          
          rem Cari semua file .cpp
          for /r src %%i in (*.cpp) do set CPP_FILES=!CPP_FILES! "%%i"
          
          rem Build dengan cl.exe (MSVC)
          cl /LD %OPT_FLAGS% /I include /Fepawnrandomix.dll %CPP_FILES% /link %LINK_FLAGS%
          
          rem Cek hasil
          dir /b *.dll
          
      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: pawnrandomix-windows
          path: pawnrandomix.dll

  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-linux, build-windows]
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        
      - name: List files
        run: |
          echo "Built files:"
          find . -name "*.so" -o -name "*.dll" | xargs -I {} ls -lh {}
          
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            pawnrandomix-linux/pawnrandomix.so
            pawnrandomix-windows/pawnrandomix.dll