name: Build Optimized

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        include:
          - os: ubuntu-latest
            cflags: "-m32 -O3 -march=native -ffast-math -funroll-loops -flto -fomit-frame-pointer"
            ext: ".so"
          - os: windows-latest
            cflags: "/O2 /Oi /Ot /Ob2 /arch:AVX2 /fp:fast /GL"
            ext: ".dll"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Linux Build
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-multilib g++-multilib

      - name: Build
        run: |
          if [ "$RUNNER_OS" == "Linux" ]; then
            # Linux build dengan optimasi
            g++ -m32 -shared -fPIC \
              ${{ matrix.cflags }} \
              -I./include \
              -o libpawnrandomix${{ matrix.ext }} \
              src/*.cpp
            strip --strip-all libpawnrandomix${{ matrix.ext }}
          else
            # Windows build - menggunakan cl langsung
            mkdir -p build
            cd build
            cl /LD ${{ matrix.cflags }} /Fe:pawnrandomix.dll \
              ..\src\*.cpp /link /OPT:REF /OPT:ICF
          fi
          
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: pawnrandomix-${{ runner.os }}
          path: |
            libpawnrandomix${{ matrix.ext }}
            pawnrandomix${{ matrix.ext }}
            build/*.dll